generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  password    String?
  role        String   @default("APPLICANT")
  companyName String?
  image       String?
  bio         String?
  phone       String?
  location    String?
  website     String?
  
  // Rating fields
  averageRating     Float @default(0)
  totalReviews      Int   @default(0)
  completedHires    Int   @default(0)
  responseRate      Float @default(0)
  isVerified        Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jobs                Job[]
  applications        Application[]
  givenReviews        Review[]        @relation("ReviewGiver")
  receivedReviews     Review[]        @relation("ReviewReceiver")
  badges              UserBadge[]
  notifications       Notification[]

  @@index([email])
  @@index([role])
  @@index([averageRating])
}

model Job {
  id          String   @id @default(cuid())
  title       String
  company     String
  location    String
  type        String
  description String
  applyUrl    String
  status      String   @default("pending")
  salaryMin   Int?
  salaryMax   Int?
  employerId  String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  employer     User          @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applications Application[]

  @@index([employerId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model Application {
  id          String   @id @default(cuid())
  jobId       String
  applicantId String
  status      String   @default("pending") // pending, reviewing, hired, rejected
  appliedAt   DateTime @default(now())
  hiredAt     DateTime?
  
  // Review tracking
  employerReviewed  Boolean @default(false)
  applicantReviewed Boolean @default(false)
  reviewReminderSent Boolean @default(false)

  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  applicant User     @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  reviews   Review[]

  @@unique([jobId, applicantId])
  @@index([applicantId])
  @@index([jobId])
  @@index([status])
}

model Review {
  id            String   @id @default(cuid())
  applicationId String
  reviewerId    String
  revieweeId    String
  reviewType    String   // "employer_review" or "applicant_review"
  
  // Rating categories (1-5 stars)
  overallRating       Int
  communication       Int?
  professionalism     Int?
  punctuality         Int?
  skills              Int?
  fairness            Int?
  workEnvironment     Int?
  paymentTimeliness   Int?
  
  comment       String?
  isVisible     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  reviewer    User        @relation("ReviewGiver", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee    User        @relation("ReviewReceiver", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@index([revieweeId])
  @@index([reviewType])
  @@index([createdAt])
}

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  icon        String
  type        String   // "employer" or "applicant"
  
  // Requirements
  minRating       Float?
  minReviews      Int?
  minCompletedHires Int?
  requiresVerification Boolean @default(false)
  
  createdAt   DateTime @default(now())

  userBadges  UserBadge[]

  @@index([type])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "review_reminder", "review_received", "badge_earned"
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  emailSent Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}
